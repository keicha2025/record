<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日日記 | Nichi-Nichi Log</title>

    <!-- PWA 核心設定 -->
    <link rel="manifest" href="manifest.json" crossorigin="use-credentials">
    <meta name="theme-color" content="#4A4A4A">

    <!-- iOS 專屬優化 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="日日記">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2544/2544087.png">

    <!-- 外部資源 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes spring-up {
            0% {
                transform: translateY(20px) scale(0.9);
                opacity: 0;
            }

            60% {
                transform: translateY(-5px) scale(1.03);
                opacity: 1;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .animate-spring-up {
            animation: spring-up 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        [v-cloak] {
            display: none;
        }
    </style>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
    <div id="app" class="max-w-md mx-auto min-h-screen relative" v-cloak>
        <div v-if="loading" class="fixed inset-0 z-[100] loading-overlay flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-2 border-gray-100 border-t-gray-500 rounded-full animate-spin mb-4"></div>
            <p class="text-[10px] tracking-[0.2em] text-gray-400 uppercase font-light">Syncing...</p>
        </div>

        <app-header :app-mode="appMode" :sync-status="syncStatus" :current-tab="currentTab"
            :history-filter="historyFilter" :show-currency-switcher="true" @retry-sync="retrySync"
            @clear-filter="historyFilter = { mode: 'all', categoryId: null, friendName: null, currency: null }">
        </app-header>

        <main class="w-full px-4 pt-4 pb-32">
            <!-- Viewer Dashboard -->
            <view-dashboard v-if="currentTab === 'overview' && appMode === 'VIEWER'" :transactions="transactions"
                :stats="stats" :friends="friends" :projects="projects" :config="systemConfig"
                :has-multiple-currencies="hasMultipleCurrencies" @switch-tab="handleTabChange"></view-dashboard>

            <!-- Regular Admin/Guest Dashboard -->
            <overview-page v-else-if="currentTab === 'overview'" :transactions="transactions" :stats="stats"
                :fx-rate="fxRate"
                @go-to-history="historyFilter = { mode: $event.mode, categoryId: null, friendName: null, currency: $event.currency }; handleTabChange('history')"></overview-page>

            <history-page v-if="currentTab === 'history'" :transactions="filteredTransactions" :categories="categories"
                :payment-methods="paymentMethods" :projects="projects" :fx-rate="fxRate" @edit-item="handleEditItem"
                @update-filter="Object.assign(historyFilter, $event)"></history-page>

            <add-page v-if="currentTab === 'add'" :form="form" :categories="categories"
                :payment-methods="paymentMethods" :friends="friends" :projects="projects" :loading="loading"
                @toggle-currency="toggleCurrency" @submit="handleSubmit(form)"
                @add-friend-to-list="handleAddFriendToList" @create-project="handleCreateProject"></add-page>
            <edit-page v-if="currentTab === 'edit'" :form="editForm" :categories="categories"
                :payment-methods="paymentMethods" :friends="friends" :projects="projects" :loading="loading"
                @submit="handleSubmit(editForm)" @delete-item="handleDelete"
                @cancel="currentTab = 'history'; editForm = null;" @create-project="handleCreateProject"
                @add-friend-to-list="handleAddFriendToList"></edit-page>
            <stats-page v-if="currentTab === 'stats'" :transactions="transactions" :categories="categories"
                :payment-methods="paymentMethods" :fx-rate="fxRate" :projects="projects"
                @drill-down="handleDrillDown"></stats-page>
            <settings-page v-if="currentTab === 'settings'" :config="systemConfig" :friends="friends"
                :transactions="transactions" :projects="projects" :app-mode="appMode" :current-user="currentUser"
                :categories="categories" :payment-methods="paymentMethods" @update-config="handleUpdateConfig"
                @update-user-data="handleUpdateUserData" @login="handleGoogleLogin" @logout="handleLogout"
                @clear-guest-data="clearGuestData" @view-friend="handleViewFriend" @view-project="handleViewProject"
                @create-project="handleCreateProject" @open-icon-edit="handleOpenIconEdit"
                @clear-account-data="handleClearAccountData" @view-import="currentTab = 'import'"
                @delete-account="handleDeleteAccount" @update:dirty="isSettingsDirty = $event"
                @manage-shared-links="currentTab = 'shared-links'"></settings-page>

            <!-- Icon Edit Page -->
            <icon-edit-page v-if="currentTab === 'icon-edit'" :context="iconEditContext" @select="handleSelectIcon"
                @cancel="currentTab = 'settings'"></icon-edit-page>

            <!-- Project Detail Page -->
            <project-detail-page v-if="currentTab === 'project-detail'" :project="selectedProject"
                :transactions="transactions" :fx-rate="fxRate" @back="currentTab = 'settings'; selectedProject = null"
                @update-project="handleUpdateProject" @view-history="handleViewHistory"></project-detail-page>

            <!-- Import Page -->
            <import-page v-if="currentTab === 'import'" @back="currentTab = 'settings'"
                @refresh-data="retrySync"></import-page>

            <!-- Shared Links Pages -->
            <shared-links-page v-if="currentTab === 'shared-links'" :current-user="currentUser"
                @back="currentTab = 'settings'"
                @create-link="() => { editingLink = null; currentTab = 'edit-shared-links'; }"
                @edit-link="(link) => { editingLink = link; currentTab = 'edit-shared-links'; }"></shared-links-page>

            <edit-shared-links-page v-if="currentTab === 'edit-shared-links'" :link-data="editingLink"
                :projects="projects" :default-user-name="systemConfig.user_name" :current-user="currentUser"
                @back="currentTab = 'shared-links'" @saved="currentTab = 'shared-links'"
                @deleted="currentTab = 'shared-links'"></edit-shared-links-page>
        </main>

        <app-footer :current-tab="currentTab" @update:current-tab="handleTabChange" :app-mode="appMode">
        </app-footer>


        <!-- Success Modal -->
        <!-- System Modal -->
        <system-modal :visible="modalState.visible" :config="modalState.config" @confirm="handleModalConfirm"
            @cancel="handleModalCancel">
        </system-modal>
    </div>

    <!-- 註冊 Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>

    <script type="module" src="./js/app.js?v=1.4"></script>
</body>

</html>